package com.wdp.quest.ui;

import com.wdp.quest.WDPQuestPlugin;
import com.wdp.quest.data.PlayerQuestData;
import com.wdp.quest.quest.Quest;
import com.wdp.quest.quest.QuestObjective;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Material;
import org.bukkit.entity.Player;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.ItemFlag;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.ItemMeta;
import org.bukkit.inventory.meta.SkullMeta;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

/**
 * Handles quest menu creation and display.
 * Layout: Double chest (54 slots) with 3 quests per page.
 * 
 * Layout visualization (9 columns x 6 rows = 54 slots):
 * Row 0: [Head] [ ] [Prev] [ ] [Title] [ ] [Close] [Next] [Currency]
 * Row 1: [Q1 Icon] [Bar1] [Bar2] [Bar3] [Bar4] [Bar5] [Bar6] [Bar7] [Bar8]
 * Row 2: [---------- Separator Row ----------]
 * Row 3: [Q2 Icon] [Bar1] [Bar2] [Bar3] [Bar4] [Bar5] [Bar6] [Bar7] [Bar8]
 * Row 4: [---------- Separator Row ----------]
 * Row 5: [Q3 Icon] [Bar1] [Bar2] [Bar3] [Bar4] [Bar5] [Bar6] [Bar7] [Bar8]
 * 
 * Progress bar uses colored glass panes as fallback (green=normal, red=hard)
 * with custom model data for resource pack textures.
 * 8 segments × 5 fills = 40 units = 100%
 */
public class QuestMenuHandler {
    
    private final WDPQuestPlugin plugin;
    private final Map<UUID, MenuState> openMenus = new HashMap<>();
    
    // Progress bar Custom Model Data values for resource pack
    // Format: 10XY where X=color(0=normal,1=hard), Y=fill(0-5)
    // Normal: 1000-1005, Hard: 1010-1015
    private static final int CMD_NORMAL_BASE = 1000;
    private static final int CMD_HARD_BASE = 1010;
    
    // Progress bar configuration
    private static final int SEGMENTS = 8;          // 8 slots for progress bar
    private static final int FILLS_PER_SEGMENT = 5; // 5 fill states per segment
    private static final int TOTAL_UNITS = SEGMENTS * FILLS_PER_SEGMENT; // 40 units = 100%
    
    // Slot positions - Main Menu Navigation (bottom row)
    private static final int PAGE_INFO_SLOT = 45;
    private static final int PLAYER_INFO_SLOT = 46;
    private static final int PREV_PAGE_SLOT = 48;
    private static final int NEXT_PAGE_SLOT = 50;
    private static final int CLOSE_SLOT = 53;
    
    // Detail Menu Navigation (bottom row)
    private static final int DETAIL_BACK_SLOT = 48;
    private static final int DETAIL_START_SLOT = 49;
    private static final int DETAIL_CLOSE_SLOT = 53;
    
    // Quest row start slots (rows 1, 3, 5 with separators at 2, 4)
    private static final int[] QUEST_ICON_SLOTS = {9, 27, 45};
    private static final int QUESTS_PER_PAGE = 3;
    
    public QuestMenuHandler(WDPQuestPlugin plugin) {
        this.plugin = plugin;
    }
    
    /**
     * Opens the main quest menu - double chest with 3 quests per page.
     */
    public void openMainMenu(Player player) {
        openMainMenu(player, 0, false);
    }
    
    /**
     * Opens the main quest menu with pagination support.
     */
    public void openMainMenu(Player player, int page) {
        openMainMenu(player, page, false);
    }
    
    /**
     * Opens the main quest menu with pagination support.
     * @param updateOnly If true, updates existing inventory instead of creating new one (prevents close event)
     */
    public void openMainMenu(Player player, int page, boolean updateOnly) {
        Inventory inv = Bukkit.createInventory(null, 54, 
            plugin.getConfigManager().getMainMenuTitle());
        
        double playerProgress = plugin.getProgressIntegration().getPlayerProgress(player);
        PlayerQuestData playerData = plugin.getPlayerQuestManager().getPlayerData(player);
        List<Quest> dailyQuests = plugin.getDailyQuestManager().getDailyQuests(player);
        
        // Fill background (except bottom row for navigation)
        for (int i = 0; i < 45; i++) {
            inv.setItem(i, createItem(Material.BLACK_STAINED_GLASS_PANE, " "));
        }
        
        // Fill bottom row with gray glass for navigation
        for (int i = 45; i < 54; i++) {
            inv.setItem(i, createItem(Material.GRAY_STAINED_GLASS_PANE, " "));
        }
        
        long completedToday = dailyQuests.stream()
            .filter(q -> playerData.isQuestCompleted(q.getId()))
            .count();
        String countdown = plugin.getDailyQuestManager().getTimeUntilResetFormatted();
        
        // Calculate pagination
        int startIndex = page * QUESTS_PER_PAGE;
        int totalPages = (int) Math.ceil((double) dailyQuests.size() / QUESTS_PER_PAGE);
        if (totalPages == 0) totalPages = 1;
        
        // === ROWS 1, 3, 5: Quest rows (with separators at rows 2, 4) ===
        fillRow(inv, 2, Material.GRAY_STAINED_GLASS_PANE);
        fillRow(inv, 4, Material.GRAY_STAINED_GLASS_PANE);
        
        for (int i = 0; i < QUESTS_PER_PAGE; i++) {
            int questIndex = startIndex + i;
            int iconSlot = QUEST_ICON_SLOTS[i];
            
            if (questIndex < dailyQuests.size()) {
                Quest quest = dailyQuests.get(questIndex);
                
                // Quest icon (first slot of row)
                inv.setItem(iconSlot, createQuestIcon(quest, playerProgress, playerData));
                
                // Progress bar (8 segments) - ALWAYS show, even if not started
                double completion = getQuestCompletion(quest, playerData);
                boolean isHard = quest.isHardQuest();
                
                // Build the lore that matches the quest icon
                List<String> barLore = buildQuestLore(quest, playerProgress, playerData);
                
                for (int seg = 0; seg < SEGMENTS; seg++) {
                    int slot = iconSlot + 1 + seg;
                    inv.setItem(slot, createProgressSegment(seg, completion, isHard, barLore));
                }
            } else {
                // Empty quest slot
                inv.setItem(iconSlot, createItem(Material.GRAY_STAINED_GLASS_PANE, "§8No Quest", "§7Check back later!"));
                for (int seg = 0; seg < SEGMENTS; seg++) {
                    int slot = iconSlot + 1 + seg;
                    inv.setItem(slot, createItem(Material.GRAY_STAINED_GLASS_PANE, " "));
                }
            }
        }
        
        // === BOTTOM ROW NAVIGATION (45-53) ===
        // Page info (slot 45)
        inv.setItem(PAGE_INFO_SLOT, createItem(Material.BOOK,
            "§b§lPage " + (page + 1) + " of " + totalPages,
            "",
            "§7Showing quests §f" + (startIndex + 1) + "-" + Math.min(startIndex + QUESTS_PER_PAGE, dailyQuests.size()),
            "§7of §f" + dailyQuests.size()
        ));
        
        // Player info (slot 46)
        double coins = plugin.getEconomyIntegration().getCoins(player);
        int tokens = (int) plugin.getEconomyIntegration().getTokens(player);
        inv.setItem(PLAYER_INFO_SLOT, createItem(Material.PLAYER_HEAD,
            "§6§lYour Progress",
            "",
            "§7Completed Today: §b" + completedToday + "§7/§a" + dailyQuests.size(),
            "§7Reset in: §e" + countdown,
            "",
            "§6SkillCoins: §e" + String.format("%.0f", coins),
            "§aTokens: §2" + tokens
        ));
        
        // Previous page (slot 48)
        if (page > 0) {
            inv.setItem(PREV_PAGE_SLOT, createItem(Material.ARROW,
                "§e§l← Previous Page",
                "",
                "§7Go to page §f" + page
            ));
        }
        
        // Next page (slot 50)
        if (page < totalPages - 1) {
            inv.setItem(NEXT_PAGE_SLOT, createItem(Material.ARROW,
                "§e§lNext Page →",
                "",
                "§7Go to page §f" + (page + 2)
            ));
        }
        
        // Close button (slot 53)
        inv.setItem(CLOSE_SLOT, createItem(Material.BARRIER,
            "§c§lClose",
            "",
            "§7Click to close menu"
        ));
        
        MenuState menuState = new MenuState(MenuType.MAIN, null, page);
        openMenus.put(player.getUniqueId(), menuState);
        
        if (updateOnly) {
            // Update existing inventory to prevent close event
            Inventory existingInv = player.getOpenInventory().getTopInventory();
            if (existingInv != null && existingInv.getSize() == 54) {
                existingInv.clear();
                for (int i = 0; i < inv.getSize(); i++) {
                    existingInv.setItem(i, inv.getItem(i));
                }
                player.updateInventory();
                return;
            }
        }
        
        player.openInventory(inv);
        player.playSound(player.getLocation(), plugin.getConfigManager().getSound("open-menu"), 0.5f, 1.0f);
    }
    
    /**
     * Opens the quest detail view.
     */
    public void openQuestDetail(Player player, Quest quest) {
        openQuestDetail(player, quest, 0, false);
    }
    
    /**
     * Opens the quest detail view, remembering the page we came from.
     */
    public void openQuestDetail(Player player, Quest quest, int fromPage) {
        openQuestDetail(player, quest, fromPage, false);
    }
    
    /**
     * Opens the quest detail view, remembering the page we came from.
     * @param updateOnly If true, updates existing inventory instead of creating new one
     */
    public void openQuestDetail(Player player, Quest quest, int fromPage, boolean updateOnly) {
        Inventory inv = Bukkit.createInventory(null, 54,
            plugin.getConfigManager().getDetailMenuTitle(quest.getDisplayName()));
        
        PlayerQuestData playerData = plugin.getPlayerQuestManager().getPlayerData(player);
        PlayerQuestData.QuestProgress questProgress = playerData.getQuestProgress(quest.getId());
        boolean isActive = playerData.isQuestActive(quest.getId());
        boolean isCompleted = playerData.isQuestCompleted(quest.getId());
        
        // Fill background (except bottom row)
        for (int i = 0; i < 45; i++) {
            inv.setItem(i, createItem(Material.GRAY_STAINED_GLASS_PANE, " "));
        }
        
        // Fill bottom row
        for (int i = 45; i < 54; i++) {
            inv.setItem(i, createItem(Material.BLACK_STAINED_GLASS_PANE, " "));
        }
        
        // Quest icon with details (slot 4)
        List<String> iconLore = new ArrayList<>();
        iconLore.add("§7" + quest.getDescription());
        iconLore.add("");
        if (quest.isHardQuest()) {
            iconLore.add("§c§l⚔ HARD QUEST ⚔");
            iconLore.add("");
        }
        iconLore.add("§7Required Progress: §e" + quest.getRequiredProgress() + "%");
        if (quest.isRepeatable()) {
            iconLore.add("§7Repeatable: §aYes");
        }
        
        ItemStack questIcon = createItem(quest.getIcon(),
            quest.getCategory().getColor() + "§l" + quest.getDisplayName(),
            iconLore.toArray(new String[0]));
        if (quest.isHardQuest()) {
            setGlowing(questIcon);
        }
        inv.setItem(4, questIcon);
        
        // Status indicator (slot 8)
        inv.setItem(8, createStatusItem(isCompleted, isActive, quest, questProgress));
        
        // === ROW 1: Full-width progress bar (slots 9-17, but we use 10-17 for bar) ===
        inv.setItem(9, createItem(Material.EXPERIENCE_BOTTLE, "§a§lProgress", 
            "§7Quest completion"));
        
        double completion = getQuestCompletion(quest, playerData);
        List<String> detailBarLore = new ArrayList<>();
        detailBarLore.add("§7Overall: §f" + String.format("%.0f", completion) + "%");
        
        for (int seg = 0; seg < SEGMENTS; seg++) {
            int slot = 10 + seg; // slots 10-17
            inv.setItem(slot, createProgressSegment(seg, completion, quest.isHardQuest(), detailBarLore));
        }
        
        // === ROW 2: Objectives header and list ===
        inv.setItem(18, createItem(Material.PAPER, "§6§lObjectives", "§7Complete all to finish"));
        
        int objSlot = 19;
        for (QuestObjective objective : quest.getObjectives()) {
            if (objSlot > 26) break; // Max 8 objectives displayed (slots 19-26)
            
            boolean objComplete = questProgress != null && questProgress.isObjectiveComplete(objective.getId());
            int current = questProgress != null ? questProgress.getObjectiveAmount(objective.getId()) : 0;
            int target = objective.getTargetAmount();
            
            Material objMat = objComplete ? Material.LIME_DYE : Material.GRAY_DYE;
            String objStatus = objComplete ? "§a✓ " : "§7○ ";
            String progress = objComplete ? "§aComplete!" : "§7" + current + "§8/§7" + target;
            
            inv.setItem(objSlot++, createItem(objMat,
                objStatus + "§f" + objective.getFormattedDescription(), progress));
        }
        
        // === ROW 3: Rewards ===
        inv.setItem(27, createItem(Material.CHEST, "§6§lRewards", "§7What you'll receive"));
        
        int rewardSlot = 28;
        for (String reward : quest.getRewards().getRewardSummary()) {
            if (rewardSlot > 35) break; // Max 8 rewards (slots 28-35)
            inv.setItem(rewardSlot++, createItem(Material.GOLD_NUGGET, reward));
        }
        
        // === BOTTOM ROW NAVIGATION (45-53) ===
        double playerProg = plugin.getProgressIntegration().getPlayerProgress(player);
        boolean canStart = playerProg >= quest.getRequiredProgress();
        
        // Back button (slot 48)
        inv.setItem(DETAIL_BACK_SLOT, createItem(Material.ARROW,
            "§e§l← Back",
            "",
            "§7Return to quest menu"
        ));
        
        // Center action button (slot 49)
        if (isActive) {
            boolean tracking = playerData.isTracking(quest.getId());
            inv.setItem(DETAIL_START_SLOT, createItem(
                tracking ? Material.ENDER_EYE : Material.ENDER_PEARL,
                tracking ? "§d§lTracking ✓" : "§e§lTrack Quest",
                "",
                "§7Toggle quest tracking",
                "",
                tracking ? "§7Click to stop tracking" : "§7Click to start tracking"
            ));
        } else if (!isCompleted) {
            if (canStart) {
                inv.setItem(DETAIL_START_SLOT, createItem(Material.EMERALD,
                    "§a§lStart Quest",
                    "",
                    "§7Click to begin!",
                    "",
                    "§8Or just start doing objectives",
                    "§8and it will auto-start!"
                ));
            } else {
                inv.setItem(DETAIL_START_SLOT, createItem(Material.BARRIER,
                    "§c§lLocked",
                    "",
                    "§7Requires §f" + quest.getRequiredProgress() + "% §7WDP progress",
                    "§7Your progress: §f" + String.format("%.1f", playerProg) + "%"
                ));
            }
        } else if (quest.isRepeatable() && !playerData.isOnCooldown(quest.getId())) {
            inv.setItem(DETAIL_START_SLOT, createItem(Material.EXPERIENCE_BOTTLE,
                "§b§lRepeat Quest",
                "",
                "§7Click to restart!"
            ));
        } else if (isCompleted) {
            inv.setItem(DETAIL_START_SLOT, createItem(Material.LIME_CONCRETE,
                "§a§l✓ Completed!",
                "",
                "§7You have finished this quest"
            ));
        }
        
        // Abandon button (slot 50) - only if active
        if (isActive) {
            inv.setItem(50, createItem(Material.TNT,
                "§c§lAbandon",
                "",
                "§7Remove quest",
                "§c⚠ Progress will be lost!"
            ));
        }
        
        // Close button (slot 53)
        inv.setItem(DETAIL_CLOSE_SLOT, createItem(Material.BARRIER,
            "§c§lClose",
            "",
            "§7Click to close menu"
        ));
        
        MenuState menuState = new MenuState(MenuType.DETAIL, quest.getId(), fromPage);
        openMenus.put(player.getUniqueId(), menuState);
        plugin.getLogger().info("[MENU DEBUG] Stored MenuState for " + player.getName() + ": type=" + menuState.type + ", data=" + menuState.data + ", fromPage=" + menuState.page);
        player.openInventory(inv);
        player.playSound(player.getLocation(), plugin.getConfigManager().getSound("click"), 0.5f, 1.0f);
    }
    
    // === PROGRESS BAR CREATION ===
    
    /**
     * Calculate quest completion percentage based on actual objective progress.
     */
    private double getQuestCompletion(Quest quest, PlayerQuestData playerData) {
        if (playerData.isQuestCompleted(quest.getId())) {
            return 100.0;
        }
        
        PlayerQuestData.QuestProgress progress = playerData.getQuestProgress(quest.getId());
        if (progress == null) {
            return 0.0;
        }
        
        // Build map of objective targets for accurate percentage calculation
        java.util.Map<String, Integer> targets = new java.util.HashMap<>();
        for (QuestObjective obj : quest.getObjectives()) {
            targets.put(obj.getId(), obj.getTargetAmount());
        }
        
        double completion = progress.getActualCompletionPercentage(targets);
        
        // Debug logging
        plugin.getLogger().info(String.format("[MENU DEBUG] Quest '%s' completion: %.1f%% (objectives: %d)",
            quest.getId(), completion, quest.getTotalObjectives()));
        
        return completion;
    }
    
    /**
     * Build lore for quest that matches the icon lore.
     */
    private List<String> buildQuestLore(Quest quest, double playerProgress, PlayerQuestData playerData) {
        List<String> lore = new ArrayList<>();
        
        boolean canStart = playerProgress >= quest.getRequiredProgress();
        boolean isActive = playerData.isQuestActive(quest.getId());
        boolean isCompleted = playerData.isQuestCompleted(quest.getId());
        
        lore.add("§7" + quest.getDescription());
        lore.add("");
        
        if (quest.isHardQuest()) {
            lore.add("§c§l⚔ HARD QUEST ⚔");
            lore.add("");
        }
        
        // Show completion status
        double completion = getQuestCompletion(quest, playerData);
        if (isCompleted) {
            lore.add("§aCompleted!");
        } else if (isActive) {
            lore.add("§7Progress: §e" + String.format("%.0f", completion) + "%");
        } else if (!canStart) {
            lore.add("§cRequires " + quest.getRequiredProgress() + "% progress");
        } else {
            lore.add("§7Ready to start!");
        }
        
        lore.add("");
        lore.add("§a▶ Click for details");
        
        return lore;
    }
    
    /**
     * Creates a progress bar segment item using colored glass panes.
     * Uses custom model data for resource pack textures.
     * Falls back to colored glass if resource pack isn't loaded.
     * 
     * @param segmentIndex Which segment (0-7)
     * @param completion Overall completion percentage (0-100)
     * @param isHard Whether this is a hard quest (red vs green)
     * @param lore Lore to display (same as quest icon)
     */
    private ItemStack createProgressSegment(int segmentIndex, double completion, boolean isHard, List<String> lore) {
        // Convert percentage to units (0-40)
        int totalFilledUnits = (int) Math.round(completion / 100.0 * TOTAL_UNITS);
        
        // Calculate this segment's fill level (0-5)
        int unitsBeforeThis = segmentIndex * FILLS_PER_SEGMENT;
        int unitsInThisSegment = Math.max(0, Math.min(FILLS_PER_SEGMENT, totalFilledUnits - unitsBeforeThis));
        
        // Choose material based on fill level and quest type
        // This provides a visible fallback if resource pack isn't loaded
        Material material;
        if (unitsInThisSegment == 0) {
            material = Material.GRAY_STAINED_GLASS_PANE; // Empty
        } else if (unitsInThisSegment < 3) {
            material = isHard ? Material.ORANGE_STAINED_GLASS_PANE : Material.LIME_STAINED_GLASS_PANE; // Partial
        } else {
            material = isHard ? Material.RED_STAINED_GLASS_PANE : Material.GREEN_STAINED_GLASS_PANE; // Full
        }
        
        // Determine Custom Model Data value for resource pack
        int cmdBase = isHard ? CMD_HARD_BASE : CMD_NORMAL_BASE;
        int customModelData = cmdBase + unitsInThisSegment;
        
        ItemStack item = new ItemStack(material);
        ItemMeta meta = item.getItemMeta();
        
        if (meta != null) {
            // Set custom model data for resource pack
            meta.setCustomModelData(customModelData);
            
            // Visual name showing fill level
            String color = isHard ? "§c" : "§a";
            String segmentBar = createSegmentVisual(unitsInThisSegment, isHard);
            meta.setDisplayName(ChatColor.translateAlternateColorCodes('§', segmentBar));
            
            // Use the same lore as the quest icon
            List<String> itemLore = new ArrayList<>();
            for (String line : lore) {
                itemLore.add(ChatColor.translateAlternateColorCodes('§', line));
            }
            meta.setLore(itemLore);
            
            meta.addItemFlags(ItemFlag.HIDE_ATTRIBUTES, ItemFlag.HIDE_ADDITIONAL_TOOLTIP);
            item.setItemMeta(meta);
        }
        
        return item;
    }
    
    /**
     * Creates a visual representation of a single segment (fallback without resource pack).
     */
    private String createSegmentVisual(int fillLevel, boolean isHard) {
        String filled = isHard ? "§c█" : "§a█";
        String empty = "§7░";
        
        StringBuilder bar = new StringBuilder();
        for (int i = 0; i < FILLS_PER_SEGMENT; i++) {
            bar.append(i < fillLevel ? filled : empty);
        }
        return bar.toString();
    }
    
    // === ITEM CREATION HELPERS ===
    
    /**
     * Creates a quest icon for the main menu.
     */
    private ItemStack createQuestIcon(Quest quest, double playerProgress, PlayerQuestData playerData) {
        boolean canStart = playerProgress >= quest.getRequiredProgress();
        boolean isActive = playerData.isQuestActive(quest.getId());
        boolean isCompleted = playerData.isQuestCompleted(quest.getId());
        
        Material icon = quest.getIcon();
        String prefix = "";
        
        if (isCompleted) {
            prefix = "§a✓ ";
        } else if (isActive) {
            prefix = "§e● ";
        } else if (!canStart) {
            icon = Material.BARRIER;
            prefix = "§c✖ ";
        }
        
        List<String> lore = buildQuestLore(quest, playerProgress, playerData);
        
        ItemStack item = createItem(icon, 
            prefix + quest.getCategory().getColor() + quest.getDisplayName(),
            lore.toArray(new String[0]));
        
        if (isCompleted || quest.isHardQuest()) {
            setGlowing(item);
        }
        
        return item;
    }
    
    /**
     * Creates a status indicator item for the detail view.
     */
    private ItemStack createStatusItem(boolean isCompleted, boolean isActive, 
                                       Quest quest, PlayerQuestData.QuestProgress questProgress) {
        Material mat;
        String name;
        String[] lore;
        
        if (isCompleted) {
            mat = Material.LIME_CONCRETE;
            name = "§a§l✓ Completed";
            lore = new String[]{"§7You have completed this quest!"};
        } else if (isActive) {
            mat = Material.YELLOW_CONCRETE;
            name = "§e§l● In Progress";
            double completion = questProgress != null ? 
                questProgress.getCompletionPercentage(quest.getTotalObjectives()) : 0;
            lore = new String[]{
                "§7Progress: §e" + String.format("%.0f", completion) + "%"
            };
        } else {
            mat = Material.GREEN_CONCRETE;
            name = "§a§l◇ Available";
            lore = new String[]{"§7Ready to start!"};
        }
        
        return createItem(mat, name, lore);
    }
    
    /**
     * Creates the player head item for the header.
     */
    private ItemStack createPlayerHead(Player player, double playerProgress, PlayerQuestData playerData) {
        ItemStack head = new ItemStack(Material.PLAYER_HEAD);
        SkullMeta meta = (SkullMeta) head.getItemMeta();
        if (meta != null) {
            meta.setOwningPlayer(player);
            meta.setDisplayName(ChatColor.translateAlternateColorCodes('§', "§6§l" + player.getName()));
            
            List<String> lore = new ArrayList<>();
            lore.add(ChatColor.translateAlternateColorCodes('§', "§7WDP Progress: §e" + String.format("%.1f", playerProgress) + "%"));
            lore.add(ChatColor.translateAlternateColorCodes('§', "§7Active Quests: §a" + playerData.getActiveQuestCount()));
            lore.add(ChatColor.translateAlternateColorCodes('§', "§7Completed: §b" + playerData.getCompletedQuestCount()));
            
            meta.setLore(lore);
            meta.addItemFlags(ItemFlag.HIDE_ATTRIBUTES);
            head.setItemMeta(meta);
        }
        return head;
    }
    
    // === BACKGROUND HELPERS ===
    
    private void fillBackground(Inventory inv, Material material) {
        ItemStack filler = createItem(material, " ");
        for (int i = 0; i < inv.getSize(); i++) {
            inv.setItem(i, filler);
        }
    }
    
    private void fillRow(Inventory inv, int row, Material material) {
        ItemStack filler = createItem(material, " ");
        int start = row * 9;
        for (int i = 0; i < 9; i++) {
            inv.setItem(start + i, filler);
        }
    }
    
    private ItemStack createItem(Material material, String name, String... lore) {
        ItemStack item = new ItemStack(material);
        ItemMeta meta = item.getItemMeta();
        if (meta != null) {
            meta.setDisplayName(ChatColor.translateAlternateColorCodes('§', name));
            
            List<String> loreList = new ArrayList<>();
            for (String line : lore) {
                if (line != null) {
                    loreList.add(ChatColor.translateAlternateColorCodes('§', line));
                }
            }
            if (!loreList.isEmpty()) {
                meta.setLore(loreList);
            }
            
            meta.addItemFlags(ItemFlag.HIDE_ATTRIBUTES, ItemFlag.HIDE_ENCHANTS, ItemFlag.HIDE_ADDITIONAL_TOOLTIP);
            item.setItemMeta(meta);
        }
        return item;
    }
    
    private void setGlowing(ItemStack item) {
        ItemMeta meta = item.getItemMeta();
        if (meta != null) {
            meta.setEnchantmentGlintOverride(true);
            item.setItemMeta(meta);
        }
    }
    
    // === MENU STATE MANAGEMENT ===
    
    public MenuState getMenuState(UUID uuid) {
        return openMenus.get(uuid);
    }
    
    public void clearMenuState(UUID uuid) {
        openMenus.remove(uuid);
    }
    
    public enum MenuType {
        MAIN,
        DETAIL
    }
    
    public static class MenuState {
        public final MenuType type;
        public final String data;
        public final int page;
        
        public MenuState(MenuType type, String data, int page) {
            this.type = type;
            this.data = data;
            this.page = page;
        }
    }
}
